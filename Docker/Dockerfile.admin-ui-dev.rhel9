FROM quay.io/centos/centos:stream9 as backendBuilder
USER root
RUN command -v curl || yum install -y curl && \
    curl -sL https://rpm.nodesource.com/setup_22.x | bash - && \
    yum install -y nodejs && \
    yum clean all

RUN node -v

WORKDIR /opt/app-root/src

COPY /apps/backend/package*.json ./
RUN npm install

COPY ./apps/backend ./

RUN npm run reset:db
RUN npm run build


FROM quay.io/centos/centos:stream9 as adminBuilder
USER root
RUN command -v curl || yum install -y curl && \
    curl -sL https://rpm.nodesource.com/setup_22.x | bash - && \
    yum install -y nodejs && \
    yum clean all

WORKDIR /opt/app-root/src

COPY /apps/admin/package*.json ./
RUN npm install

COPY ./apps/admin ./

RUN rm ./public/config.json
RUN mv ./public/config.docker.json ./public/config.json

ENV BASE_URL="/admin"

RUN npm run build


FROM quay.io/centos/centos:stream9
RUN command -v curl || yum install -y curl && \
    curl -sL https://rpm.nodesource.com/setup_22.x | bash - && \
    yum install -y nodejs && \
    yum clean all

WORKDIR /opt/app-root/src
COPY /apps/backend/package*.json ./
COPY --from=backendBuilder /opt/app-root/src/dist ./
COPY /apps/backend/.env.example .env
COPY /apps/backend/prisma ./prisma
COPY /apps/backend/static ./static
RUN mkdir logs

USER root
RUN npm install && npx prisma generate

RUN chown -R 1001:0 /opt/app-root/src/
USER 1001

RUN chmod -R 775 /opt/app-root/src

COPY --from=adminBuilder /opt/app-root/src/dist ./static/admin

EXPOSE 3002

ENV TZ "Europe/Stockholm"
ENV PORT 3002
ENV HOSTNAME "0.0.0.0"

CMD ["npm", "run", "start:prod"]